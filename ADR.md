# ADR Log

## [2025-01-09 12:00] ADR-001: Выбор TypeScript и ES Modules для реализации MCP сервера

### Статус
Принято

### Контекст
Необходимо выбрать язык программирования и модульную систему для реализации MCP сервера для Wildberries API.

### Решение
Использовать TypeScript 5.7+ с ES Modules (type: "module" в package.json) и Node.js 18+.

### Обоснование
- **TypeScript**: Строгая типизация предотвращает ошибки на этапе разработки, особенно важно для работы с внешним API
- **ES Modules**: Современный стандарт модулей, нативная поддержка в Node.js 18+, лучшая совместимость с @modelcontextprotocol/sdk
- **Node.js 18+**: LTS версия, поддержка современных JS фич, стабильность

### Последствия
**Положительные:**
- Безопасность типов на этапе компиляции
- Отличная поддержка IDE (автодополнение, рефакторинг)
- Современный синтаксис и возможности

**Отрицательные:**
- Требуется этап компиляции (tsc)
- Увеличение размера проекта (devDependencies)

### Альтернативы рассмотрены
- **JavaScript**: Проще, но отсутствие типизации увеличивает риск ошибок
- **CommonJS**: Устаревший стандарт, хуже совместимость с современными библиотеками

---

## [2025-01-09 12:00] ADR-002: Использование Zod для валидации данных

### Статус
Принято

### Контекст
Необходим механизм валидации входных параметров инструментов и переменных окружения.

### Решение
Использовать библиотеку Zod для определения схем и валидации данных.

### Обоснование
- Декларативное определение схем с автоматическим выводом TypeScript типов
- Понятные сообщения об ошибках валидации
- Встроенная поддержка трансформаций и значений по умолчанию
- Отличная интеграция с TypeScript

### Последствия
**Положительные:**
- Единый подход к валидации во всём проекте
- Типобезопасность: схема Zod = TypeScript тип
- Читаемый и поддерживаемый код

**Отрицательные:**
- Дополнительная зависимость (~60KB)
- Небольшой overhead на валидацию

### Альтернативы рассмотрены
- **Joi**: Более зрелая библиотека, но хуже интеграция с TypeScript
- **Yup**: Похожий функционал, но менее современный API

---

## [2025-01-09 12:00] ADR-003: Модульная структура инструментов по разделам API

### Статус
Принято

### Контекст
Необходимо организовать структуру инструментов для удобства разработки и поддержки.

### Решение
Разделить инструменты по разделам API Wildberries в отдельные директории:
- `src/tools/products/` - товары
- `src/tools/orders/fbs/` - заказы FBS
- `src/tools/analytics/` - аналитика

Каждый раздел содержит:
- Отдельные файлы для каждого инструмента
- `index.ts` для экспорта и регистрации

### Обоснование
- **Модульность**: Легко добавлять новые инструменты
- **Изоляция**: Изменения в одном разделе не влияют на другие
- **Читаемость**: Понятная структура проекта
- **Масштабируемость**: Можно легко добавить новые разделы

### Последствия
**Положительные:**
- Чистая организация кода
- Простота навигации
- Возможность параллельной разработки разных разделов

**Отрицательные:**
- Больше файлов в проекте
- Необходимость поддерживать index.ts файлы

### Альтернативы рассмотрены
- **Монолитный файл**: Все инструменты в одном файле - плохая поддерживаемость
- **Плоская структура**: Все инструменты в одной папке - хаос при масштабировании

---

## [2025-01-09 12:00] ADR-004: Rate Limiting со скользящим окном

### Статус
Принято

### Контекст
Wildberries API имеет ограничения на частоту запросов. Необходимо предотвратить превышение лимитов.

### Решение
Реализовать Rate Limiter со скользящим окном (sliding window):
- 100 запросов в минуту (по умолчанию)
- Автоматическое ожидание при превышении лимита
- Глобальный экземпляр для всех запросов

### Обоснование
- **Скользящее окно**: Более справедливое распределение запросов, чем fixed window
- **Автоматическое ожидание**: Прозрачная обработка без ошибок для пользователя
- **Глобальный экземпляр**: Единый контроль для всех клиентов API

### Последствия
**Положительные:**
- Защита от ban по API
- Предсказуемая производительность
- Автоматическая обработка rate limits

**Отрицательные:**
- Задержки при высокой нагрузке
- Дополнительная сложность кода

### Альтернативы рассмотрены
- **Fixed window**: Проще, но менее справедливо
- **Token bucket**: Более сложная реализация
- **Без rate limiting**: Риск ban от API

---

## [2025-01-09 12:00] ADR-005: Retry логика с экспоненциальным backoff

### Статус
Принято

### Контекст
Временные ошибки API (network, timeout, 5xx) должны обрабатываться автоматически.

### Решение
Реализовать retry механизм с экспоненциальным backoff:
- Максимум 3 попытки
- Задержки: 1s, 2s, 4s (+ случайный jitter)
- Только для временных ошибок (5xx, network, timeout)

### Обоснование
- **Экспоненциальный backoff**: Снижает нагрузку на API при проблемах
- **Jitter**: Предотвращает синхронизацию retry от разных клиентов
- **Только временные ошибки**: 4xx ошибки не retry-able

### Последствия
**Положительные:**
- Повышение надёжности
- Автоматическое восстановление от временных сбоев
- Меньше ошибок для конечного пользователя

**Отрицательные:**
- Увеличение времени отклика при ошибках
- Дополнительная нагрузка на API

### Альтернативы рассмотрены
- **Линейный backoff**: Менее эффективен при высокой нагрузке
- **Без retry**: Меньше надёжность
- **Бесконечные retry**: Риск зависания запросов
